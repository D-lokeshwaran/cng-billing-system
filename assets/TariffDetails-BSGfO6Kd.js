import{j as t,k as R,I as V,B as E,r as A,h as z,q as O,c as W,t as v,e as D,R as _,C as q,i as U}from"./index-BBZVF_XH.js";import{a as Y,b as G}from"./index.esm-16HUKa1g.js";import{H as J}from"./HookForm-Lmu3z8lE.js";import{D as H}from"./DatePickerInput-BQPNKk5-.js";import{F as K}from"./FeatureHeader-DpyJK2EI.js";import{o as L}from"./delete02-icon-CGhQGn9A.js";import{E as w}from"./ErrorMessage-BmJuqbm7.js";import{A as B}from"./labels--gJQxQlO.js";import{C as Q}from"./FormSelect-CRrV35Dd.js";import"./FormCheck-B5v7tI3p.js";import"./index-hmsTSLU8.js";import"./date-DOahnHON.js";const X=({maxUnitRate:a})=>{var r,u,c,p,b,x;const{register:d,formState:{errors:e},watch:l,trigger:m,setValue:n}=Y(),{fields:j,append:T,remove:y}=G({name:"unitsAndRates",keyName:"id"}),f=l("unitsAndRates"),i=f[j.length-1],g=f.map(h=>parseInt(h.toUnit)).sort().reverse()[0];n("maxUnit",parseInt(g)+1);const s=(u=(r=e==null?void 0:e.unitsAndRates)==null?void 0:r.filter(h=>(h==null?void 0:h.toUnit)!==null))==null?void 0:u[0];return t.jsxs("table",{className:"w-100",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"m-4 p-5",children:[t.jsx("th",{children:"From Unit"}),t.jsx("th",{children:"To Unit"}),t.jsx("th",{children:"Rate per Unit"})]})}),t.jsx("tbody",{children:j.map((h,o)=>{var C,N,$,k,F,S;const I=f[o-1],P=f[o];f[o+1];const M=parseInt(l(`unitsAndRates.${o-1}.toUnit`))+1||1;return t.jsxs("tr",{children:[t.jsx("td",{children:t.jsx(R,{...d(`unitsAndRates.${o}.fromUnit`,{value:M}),value:M,step:.01,disabled:!0})}),t.jsx("td",{children:t.jsx(R,{...d(`unitsAndRates.${o}.toUnit`,{required:{value:!0,message:"To unit(s) are required."},min:{value:parseInt(P==null?void 0:P.fromUnit)+1,message:"To unit should be greater than from unit."}}),isInvalid:($=(N=(C=e==null?void 0:e.unitsAndRates)==null?void 0:C[o])==null?void 0:N.toUnit)==null?void 0:$.message,type:"number"})}),t.jsx("td",{children:t.jsx(R,{...d(`unitsAndRates.${o}.ratePerUnit`,{valueAsNumber:!0,required:{value:!0,message:"Rate per Unit(s) are required."},min:{value:I==null?void 0:I.ratePerUnit,message:"Rate per unit should be greater than previos rate per unit"}}),isInvalid:(S=(F=(k=e==null?void 0:e.unitsAndRates)==null?void 0:k[o])==null?void 0:F.ratePerUnit)==null?void 0:S.message,type:"number",step:"any"})}),o>2&&t.jsx("td",{className:"ps-3 pe-2",children:t.jsx(V,{icon:L,onClick:()=>y(o),variant:"default-danger",className:"p-2"})})]},h.id)})}),t.jsxs("tfoot",{children:[t.jsx("tr",{children:t.jsxs("td",{colSpan:4,children:[t.jsx(w,{errorMessage:(c=s==null?void 0:s.toUnit)==null?void 0:c.message}),t.jsx(w,{errorMessage:(p=s==null?void 0:s.ratePerUnit)==null?void 0:p.message})]})}),t.jsxs("tr",{children:[t.jsx("td",{children:t.jsx(E,{size:"sm",variant:"default",onClick:()=>{m("unitsAndRates"),!(s||!i.toUnit||!i.ratePerUnit)&&T({fromUnit:parseInt(i.toUnit)+1})},children:"+ Add Item"})}),t.jsxs("td",{className:"d-flex justify-content-end mt-2",children:[t.jsx(R,{...d("maxUnit"),type:"hidden"}),"Rate above ",g," unit:"]}),t.jsxs("td",{children:[t.jsx(R,{...d("unitRateAboveMax",{value:a,required:{value:!0,message:"Rate is required"},min:{value:parseFloat(i==null?void 0:i.ratePerUnit),message:`Should be greater than last rate (${i==null?void 0:i.ratePerUnit})`}}),type:"number",step:"any",isInvalid:(b=e==null?void 0:e.unitRateAboveMax)==null?void 0:b.message}),t.jsx(w,{errorMessage:(x=e==null?void 0:e.unitRateAboveMax)==null?void 0:x.message})]})]})]})]})},Z=[{fromUnit:1,toUnit:100,ratePerUnit:2},{fromUnit:101,toUnit:200,ratePerUnit:5},{fromUnit:201,toUnit:300,ratePerUnit:9}],ft=()=>{const[a,d]=A.useState(),{billDetails:e}=z(),[l,m]=A.useState(),{tariffId:n}=O(),j=W();A.useEffect(()=>{n&&n!="new"?T(n):d(null)},[n]);const T=async s=>{let u=(await v(D.get(`/cng/tariffs/${s}`))).data;d(u)},y=async s=>{const{maxUnit:r,unitRateAboveMax:u,...c}=s;c.unitsAndRates.push({fromUnit:r,toUnit:"above",ratePerUnit:u});const p=await f(c);if(n>0&&p){await v(D.put(`/cng/tariffs/${n}`,c)).catch(x=>console.log("Failed to update tariff:",x))&&j.back();return}p||await v(D.post("/cng/tariffs",c)).catch(x=>console.log("Failed to create tariff:",x))&&j.back(),m(p)},f=async s=>{const r=U(s.fromDate).format("YYYY-MM-DD");var c=(await v(D.get(`/cng/tariffs/search/checkDuplicate?fromDate=${r}`))).data._embedded.tariffs.length>0;return c},i=A.useMemo(()=>{if(a){const s=a.unitsAndRates.filter(r=>r.toUnit!=="above");return{...a,unitsAndRates:s}}return{unitsAndRates:Z}},[a,a==null?void 0:a.unitsAndRates]),g=A.useMemo(()=>{if(!a)return;const r=a.unitsAndRates.find(u=>u.toUnit==="above");return(r==null?void 0:r.ratePerUnit)??null},[a,a==null?void 0:a.unitsAndRates]);return t.jsx("div",{id:"tariff-details",children:t.jsxs(J,{onSubmit:y,defaultValues:{...i},children:[t.jsx(K,{title:"Create Tariff",className:"justify-content-between",breadcrumbs:[{title:"Bill",path:"/bills",hidden:!e},{title:`${e!=null&&e.billId?"#"+(e==null?void 0:e.billId):"New"}`,path:`/bills/${(e==null?void 0:e.billId)||"new"}`,hidden:!e},{title:"Tariff",path:"/tariffs"},{title:n&&n!=="new"?`${a==null?void 0:a.fromDate} to ${a==null?void 0:a.toDate}`:"New",disabled:!0}],children:t.jsx(E,{variant:"primary",type:"submit",children:n?B.UPDATE:B.CREATE})}),t.jsxs(Q,{body:!0,children:[t.jsxs("div",{className:"mb-3",children:[t.jsxs(_,{children:[t.jsx(q,{children:t.jsx(H,{field:{title:"From date",state:"fromDate"},validate:{pastDate:s=>{if(!n){let r=U(new Date).subtract(1,"d");return U(r).isBefore(s)||"From Date should not be at past"}return!0}},filterDate:s=>U(s).add(1,"days").isAfter(new Date),disabled:n})}),t.jsx(q,{children:t.jsx(tt,{disabled:n})})]}),l&&t.jsx(w,{errorMessage:"Duplicate Tariff exists on these date's"})]}),t.jsx(X,{maxUnitRate:g})]})]})})},tt=({disabled:a,...d})=>{const{watch:e}=Y(),l=e("fromDate");return t.jsx(H,{field:{title:"To date",state:"toDate"},disabled:a,...d,filterDate:m=>U(m).add(1,"days").isAfter(l),highlightDates:[l],validate:{afterFromDate:m=>{if(!a)return U(m).isAfter(l)||"To Date should be after from date"}}})};export{tt as ToDateWithValidation,ft as default};
