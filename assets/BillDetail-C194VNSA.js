import{y as D,h as P,r as f,t as y,e as N,i as $,j as e,F as p,k as E,R as k,C as m,f as Z,l as J,I as w,M as T,S as K,m as Y,B,n as Q,c as H,q as W}from"./index-8ZxL3BOu.js";import{H as X}from"./HookForm-BDC8bDrS.js";import{F as ee}from"./FeatureHeader-Drbb-O_F.js";import{D as se}from"./DatePickerInput-D_9bwHvy.js";import{E as R}from"./ErrorMessage-O5B_GVRS.js";import{a as z}from"./index.esm-CbKD2Vy3.js";import{f as te}from"./date-Blq-6M25.js";import{C as U}from"./labels--gJQxQlO.js";import{C as v}from"./FormSelect-BLxoVz7i.js";import{r as L,l as ae}from"./lodash-CZujAbtQ.js";import{c as F}from"./customerSlice-CdKs_JbP.js";import{u as _,o as ne,a as re,c as ce,T as oe}from"./TanStackTable-BHkc79HC.js";import{B as ie}from"./Badge-TnUlcZyn.js";import"./index-UD_oI_iy.js";import"./FormCheck-CN9Zz36o.js";import"./Table-BaxILlKU.js";/**
 * @license hugeicons-react v0.1.3
 *
 * See the LICENSE file in the root directory of this source tree.
 */const le=D("ArrowMoveDownLeftIcon",[["path",{d:"M20 3V5.07692C20 7.07786 20 8.07833 19.8547 8.91545C19.0547 13.5235 15.0934 17.1376 10.0426 17.8674C9.12509 18 7.19318 18 5 18",stroke:"currentColor",key:"k0"}],["path",{d:"M7 21C6.39316 20.4102 4 18.8403 4 18C4 17.1597 6.39316 15.5898 7 15",stroke:"currentColor",key:"k1"}]]);/**
 * @license hugeicons-react v0.1.3
 *
 * See the LICENSE file in the root directory of this source tree.
 */const de=D("Attachment02Icon",[["path",{d:"M8 8.00049V6.00049C8 3.79135 9.79086 2.00049 12 2.00049C14.2091 2.00049 16 3.79135 16 6.00049V18.0005C16 20.2096 14.2091 22.0005 12 22.0005C9.79086 22.0005 8 20.2096 8 18.0005V13.5005C8 12.1198 9.11929 11.0005 10.5 11.0005C11.8807 11.0005 13 12.1198 13 13.5005V16.0005",stroke:"currentColor",key:"k0"}]]);/**
 * @license hugeicons-react v0.1.3
 *
 * See the LICENSE file in the root directory of this source tree.
 */const G=D("DatabaseAddIcon",[["path",{d:"M11 15C6.58172 15 3 13.6569 3 12",stroke:"currentColor",key:"k0"}],["path",{d:"M19 5V11.5M3 5V19C3 20.6569 6.58172 22 11 22C11.1679 22 11.3346 21.9981 11.5 21.9942",stroke:"currentColor",key:"k1"}],["ellipse",{cx:"11",cy:"5",rx:"8",ry:"3",stroke:"currentColor",key:"k2"}],["path",{d:"M7 8V10",stroke:"currentColor",key:"k3"}],["path",{d:"M7 15V17",stroke:"currentColor",key:"k4"}],["path",{d:"M17 16.6667V18M17 18V19.3333M17 18H18.3333M17 18H15.6667M21 18C21 20.2091 19.2091 22 17 22C14.7909 22 13 20.2091 13 18C13 15.7909 14.7909 14 17 14C19.2091 14 21 15.7909 21 18Z",stroke:"currentColor",key:"k5"}]]),me=({tariff:c,setBillTariff:u})=>{var h,M;const{register:s,formState:{errors:i},watch:t,setValue:r,setError:x,clearErrors:l}=z(),{billDetails:a,setBillDetails:I}=P(),[b,g]=f.useState(),d=t("unitsConsumed"),n=t("billingDate"),o=(b*parseInt(d||(a==null?void 0:a.unitsConsumed))).toFixed(2);f.useEffect(()=>{r("unitsConsumed",a==null?void 0:a.unitsConsumed),r("billingDate",(a==null?void 0:a.billingDate)||new Date),C()},[]),f.useEffect(()=>{I({...a,unitsConsumed:d,billingDate:n})},[d,n]);const C=async()=>{await y(N({url:"/cng/tariffs/search/findByDate",method:"GET",params:{searchDate:$(n).format("YYYY-MM-DD")||new Date}})).then(j=>{const S=j.data;I({...a,tariffId:S.id}),u(S)}).catch(j=>{console.log(`No tariff for ${n||"today"} add one.`),I({...a,tariffId:null}),u(null)})};return f.useEffect(()=>{const j=c==null?void 0:c.unitsAndRates,S=parseInt(d)||(a==null?void 0:a.unitsConsumed);j?j.forEach(A=>{A.fromUnit<=S&&(A.toUnit==="above"||parseInt(A.toUnit)>=S)&&g(A.ratePerUnit)}):g(null),r("billAmount",o)},[d,c]),e.jsxs(v,{children:[e.jsxs(v.Header,{children:[e.jsx("h3",{className:"mb-0",children:"Details"}),e.jsx("small",{className:"text-secondary",children:"Change units consumed to calculate bill amount."})]}),e.jsxs(v.Body,{children:[e.jsxs(p,{justify:"between",children:[e.jsxs("span",{children:["Units consumed ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs("span",{children:[e.jsx(E,{...s("unitsConsumed",{required:{value:!0,message:"Units consumed is required"},validate:{positiveNumber:j=>j>0||"Units consumed must be positive",tariffRequired:j=>c||"No tariff to calculate"}}),size:"sm",type:"number",disabled:a==null?void 0:a.billId,isInvalid:((h=i==null?void 0:i.unitsConsumed)==null?void 0:h.message)!=null}),e.jsx(R,{errorMessage:(M=i==null?void 0:i.unitsConsumed)==null?void 0:M.message})]})]}),e.jsx("hr",{className:"border-style-dotted"}),e.jsx(p,{justify:"end",children:e.jsxs("div",{className:"w-75",children:[e.jsxs(k,{className:"justify-content-between align-items-center mb-2",children:[e.jsx(m,{className:"text-end",children:"Billing Date"}),e.jsx(m,{className:"text-end",children:e.jsx(se,{field:{title:"Billing Date",state:"billingDate",defaultValue:new Date},required:!1,showLabel:!1,isClearable:!1,disabled:a==null?void 0:a.billId,onChangeDate:C,className:"form-control-sm"})})]}),e.jsxs(k,{className:"justify-content-between mb-2",children:[e.jsx(m,{className:"text-end",children:e.jsx("span",{children:"Payment Due Date "})}),e.jsxs(m,{className:"text-end",children:[e.jsx(E,{...s("paymentDueDate",{value:$(n).add(10,"days").toDate(),valueAsDate:!0}),hidden:!0}),n?te($(n).add(10,"days")):U.NO_DATA]})]}),e.jsxs(k,{className:"justify-content-between mb-2",children:[e.jsx(m,{className:"text-end",children:"Rate per unit"}),e.jsx(m,{className:"text-end",children:b||U.NO_DATA})]}),e.jsxs(k,{className:"justify-content-between mb-2",children:[e.jsx(m,{className:"text-end",children:"Billing Amount"}),e.jsxs(m,{className:"text-end",children:[e.jsx(E,{...s("billAmount",{value:b*parseInt(d)||0,valueAsNumber:!0}),value:b*parseInt(d)||0,type:"hidden"}),Number(o)?o:U.NO_DATA]})]})]})})]})]})},q=5,ue=({show:c,onClose:u})=>{const{billDetails:s,setBillDetails:i}=P(),{table:t}=_({name:F.name,columns:F.columns,params:F.params});f.useEffect(()=>{t.setPageSize(q)},[]);const r=e.jsx(Z,{"aria-details":"",as:"ul",children:t.getRowModel().rows.map(x=>{const l=x.original;return e.jsx(J,{as:"li",action:!0,className:"text-dark btn-reveal-trigger cursor-pointer",onClick:()=>{i({...s,customerId:l.id}),u()},children:e.jsxs(k,{className:"align-items-center",children:[e.jsxs(m,{style:{fontSize:"0.8rem"},children:[e.jsxs("div",{className:"fs-6",children:["#",l.accountNumber," . ",l.fullName," "]}),e.jsx("div",{className:"text-secondary",children:l.emailAddress||"demouser@gmail.com"}),e.jsx("div",{className:"text-secondary",children:"99415787856"})]}),e.jsx(m,{sm:"auto",children:e.jsx(w,{icon:le,className:"btn-reveal"})})]})},x.id)})});return e.jsxs(T,{show:c,onHide:u,size:"lg",children:[e.jsx(T.Header,{className:"d-block",children:e.jsxs(k,{className:"g-0 justify-content-between",children:[e.jsx(m,{sm:7,md:9,children:e.jsx(K,{value:t.getState().globalFilter??"",onChange:x=>t.setGlobalFilter(String(x)),debounce:200,placeholder:"Search customers...",autoFocus:!0})}),e.jsxs(m,{sm:3,className:"p-0 d-flex align-items-center justify-content-end",children:[e.jsxs("span",{className:"me-3",children:[q," - ",t.getState().pagination.pageIndex]}),e.jsx(w,{icon:ne,className:Y("me-1",{"text-secondary":!t.getCanPreviousPage()}),onClick:()=>{t.getCanPreviousPage()&&t.previousPage()}}),e.jsx(w,{icon:re,className:Y("cursor-pointer",{"text-secondary":!t.getCanNextPage()}),onClick:()=>{t.getCanNextPage()&&t.nextPage()}})]})]})}),e.jsx(T.Body,{className:"p-0",children:r}),e.jsx(T.Footer,{children:e.jsx(B,{variant:"secondary",size:"sm",onClick:u,children:"Cancel"})})]})},xe=()=>{var g,d;const{setValue:c,register:u,formState:{errors:s}}=z(),[i,t]=Q(),{billDetails:r,setBillDetails:x}=P(),l=H(),[a,I]=f.useState(),b=async n=>{try{if(n){const o=await y(N.get(`/cng/customers/${n}`));I(o.data)}}catch(o){console.error("Failed to fetch Customer:",o)}};return f.useEffect(()=>{let n=r==null?void 0:r.customerId;b(n),c("customerId",n)},[r==null?void 0:r.customerId]),e.jsxs(e.Fragment,{children:[e.jsx(ue,{show:i,onClose:t,chosenCustomerId:r==null?void 0:r.customerId}),e.jsx("input",{type:"hidden",...u("customerId",{validate:{required:n=>a||"No customer selected for this bill"}})}),e.jsxs(v,{body:!0,className:"h-100",children:[e.jsxs(p,{justify:"between",className:"mb-3",children:[e.jsx("h3",{children:"Customer info"}),e.jsxs("div",{children:[a&&e.jsx(w,{icon:L,className:"me-1",onClick:()=>l.push(`/customers/${a.id}`)}),e.jsx(w,{className:"p-0",disabled:r==null?void 0:r.billId,onClick:t,icon:de})]})]}),a?e.jsxs("div",{children:[e.jsxs("div",{children:[e.jsxs(p,{justify:"between",className:"mb-2",children:[e.jsx("span",{children:"Account No:"}),e.jsx("span",{children:a.accountNumber})]}),e.jsxs(p,{justify:"between",className:"mb-2",children:[e.jsx("span",{children:"Name:"}),e.jsx("span",{children:a.fullName})]}),e.jsxs(p,{justify:"between",className:"mb-2",children:[e.jsx("span",{children:"Email:"}),e.jsx("span",{children:a.emailAddress})]}),e.jsxs(p,{justify:"between",className:"mb-2",children:[e.jsx("span",{children:"Bills:"}),e.jsx("span",{children:"3"})]})]}),e.jsx("hr",{}),e.jsxs("div",{children:[e.jsx("h4",{children:"Billing Address"}),e.jsxs(p,{justify:"between",className:"mb-2",children:[e.jsx("span",{children:"Address:"}),e.jsx("span",{children:a.billingAddress})]}),e.jsxs(p,{justify:"between",className:"mb-2",children:[e.jsx("span",{children:"Mobile No:"}),e.jsx("span",{children:a.contactNumber})]})]})]}):e.jsxs("div",{className:"text-center",children:[e.jsx(G,{size:"14%",className:`${(g=s==null?void 0:s.customerId)!=null&&g.message?"text-danger":"gray-100"} mb-0`}),e.jsx(R,{errorMessage:(d=s==null?void 0:s.customerId)==null?void 0:d.message,className:"justify-content-center "}),e.jsx("div",{className:"mb-4",children:e.jsx("small",{className:"text-secondary",children:"You haven't added any Customer to this bill. Create a Customer or choose one."})}),e.jsx(B,{size:"sm",type:"button",onClick:()=>l.push("/customers/new"),children:"Create Customer"})]})]})]})},V=ce(),O={name:"unitsAndRates",columns:[V.accessor("fromUnit",{header:"From unit"}),V.accessor("toUnit",{header:"To unit"}),V.accessor("ratePerUnit",{header:"Rate per unit"})]},he=({data:c})=>{const u=H(),{billDetails:s}=P(),{register:i,formState:{errors:t}}=z(),r=()=>{var x,l;if(c){const{table:a}=_({columns:O.columns,_mock:c[O.name],options:{enableRowSelection:!1}});return e.jsx(oe,{table:a})}else return e.jsxs("div",{className:"text-center",children:[e.jsx(G,{size:"14%",className:`${(x=t==null?void 0:t.tariffId)!=null&&x.message?"text-danger":"gray-100"} mb-0`}),e.jsx(R,{errorMessage:(l=t==null?void 0:t.tariffId)==null?void 0:l.message,className:"justify-content-center "}),e.jsx("div",{className:"mb-4",children:e.jsxs("small",{className:"text-secondary",children:["Tariff doesn't exists for billing Date (",$(s==null?void 0:s.billingDate).format("DD-MM-YYYY"),"). Create a Tariff or change billing Date."]})}),e.jsx(B,{size:"sm",type:"button",onClick:()=>u.push("/tariffs/new"),children:"Create Tariff"})]})};return e.jsxs(v,{className:"mt-3 rounded",children:[e.jsxs(v.Header,{className:"d-flex justify-content-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"mb-0",children:"Tariffs"}),e.jsx("small",{className:"text-secondary",children:"Based on billing date tariffs will change."})]}),c&&!(s!=null&&s.billId)&&e.jsx(w,{icon:L,onClick:()=>u.push(`/tariffs/${c==null?void 0:c.id}`)})]}),e.jsxs(v.Body,{children:[e.jsx("input",{type:"hidden",...i("tariffId",{validate:{required:x=>(s==null?void 0:s.tariffId)||"Tariff is required."}})}),e.jsx(r,{})]})]})},Pe=()=>{const[c,u]=f.useState(),[s,i]=f.useState(),{billDetails:t,setBillDetails:r}=P();let x=(s==null?void 0:s.id)&&(s==null?void 0:s.paymentStatus)=="Pending"&&(t==null?void 0:t.tariffId);const l=H(),{billId:a}=W();f.useEffect(()=>{I()},[a]),f.useEffect(()=>{r({...t,billId:s==null?void 0:s.id,customerId:s==null?void 0:s.customerId})},[s]);const I=async()=>{if(!a){r({...t,billId:"new"});return}const o=(await y(N.get(`/cng/bills/${a}`))).data;await y(N.get(`/cng/bills/${a}/customer`)).then(C=>{let h=C.data.id;o.customerId=h,i(o)}).catch(C=>{console.log("Customer doesn't exists for this bill",C)})},b=async n=>{const{customerId:o,...C}=n;console.log(n);const h=await y(N({url:s?`/cng/bills/${s.id}`:"/cng/bills",method:s?"PUT":"POST",data:C})),M=h==null?void 0:h.data.id,j=c==null?void 0:c.id;j&&await y(N.put(`/cng/bills/${M}/tariff`,`/cng/tariffs/${j}`,{headers:{"Content-Type":"text/uri-list"}})),o&&await y(N.put(`/cng/bills/${M}/customer`,`/cng/customers/${o}`,{headers:{"Content-Type":"text/uri-list"}})),l.push("/bills")},g=async n=>{const o={...s,paymentStatus:n};console.log(s);const h=(await y(N.put(`/cng/bills/${s.id}`,o))).data;t!=null&&t.customerId&&await y(N.put(`/cng/bills/${h==null?void 0:h.id}/customer`,`/cng/customers/${t==null?void 0:t.customerId}`,{headers:{"Content-Type":"text/uri-list"}})),l.push("/bills")},d=f.useMemo(()=>{let n=(s==null?void 0:s.paymentStatus)||"NotBilled",o="";return n==="Overdue"?o="danger":n==="Completed"?o="success":n==="Pending"?o="warning":o="secondary",{name:n,type:o}},[s==null?void 0:s.paymentStatus]);return e.jsx("div",{id:"cng-bill-details",children:e.jsxs(X,{onSubmit:b,defaultValues:s,children:[e.jsx(ee,{title:"Bill",className:"justify-content-between",breadcrumbs:[{title:"Bill",path:"/bills"},{title:a==="new"?"New":`${t!=null&&t.billId?"#"+(t==null?void 0:t.billId):"New"}`,disabled:!0}],children:e.jsxs(p,{className:"justify-content-between w-100",children:[e.jsx(ie,{pill:!0,bg:"none",className:`ms-3 text-${d.type} border border-${d.type} d-flex align-items-center`,children:ae.startCase(d.name)}),e.jsxs("div",{children:[x&&e.jsx(B,{variant:"default",type:"button",onClick:()=>g("Completed"),children:"Mark as paid"}),(s==null?void 0:s.paymentStatus)==="Completed"&&e.jsx(B,{variant:"default",type:"button",onClick:()=>g("Pending"),children:"Undo Bill"}),!(t!=null&&t.billId)&&e.jsx(B,{variant:"primary",type:"submit",children:s?"Update":"Create"})]})]})}),e.jsxs(k,{children:[e.jsxs(m,{children:[e.jsx(me,{tariff:c,setBillTariff:u}),e.jsx(he,{data:c})]}),e.jsx(m,{xs:12,lg:6,className:"mt-3 mt-lg-0",children:e.jsx(xe,{})})]})]})})};export{Pe as default};
